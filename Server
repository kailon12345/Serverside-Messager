-- [[ CONFIGURATION ]]
local firebaseURL = "https://roblox-chat-script-default-rtdb.firebaseio.com/message.json"
local webhookURL = "https://discord.com/api/webhooks/1456792417700286655/t5XoB-iOUF_vjz5dDMfEdYfbJRiH1CDl2fm3RJbpXB1DCErvugZS0GZj7JUKGgczT3GS"
local lastMsg = ""

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local lp = Players.LocalPlayer

-- [[ ID MAPPING ]]
local UserIDMap = {
    ["Schwein"] = 7789664710,
    ["Surround6"] = 10030354673
}

-- [[ EXECUTOR DETECTION ]]
local function getExecutor()
    return (identifyexecutor and identifyexecutor()) or (getexecutorname and getexecutorname()) or "Unknown"
end
local myExec = getExecutor()

-- [[ GUI CONSTRUCTION ]]
local ScreenGui = Instance.new("ScreenGui", game:GetService("CoreGui"))
local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0, 360, 0, 420)
Main.Position = UDim2.new(0.5, -180, 0.5, -210)
Main.BackgroundColor3 = Color3.fromRGB(15, 15, 17)
Main.BorderSizePixel = 0
Main.Active = true
Main.Draggable = true

local TopBar = Instance.new("Frame", Main)
TopBar.Size = UDim2.new(1, 0, 0, 35)
TopBar.BackgroundColor3 = Color3.fromRGB(5, 5, 7)

local Title = Instance.new("TextLabel", TopBar)
Title.Size = UDim2.new(1, -40, 1, 0)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.Text = "SCHWEINS SCRIPT CHAT"
Title.TextColor3 = Color3.fromRGB(255, 170, 0)
Title.BackgroundTransparency = 1
Title.TextXAlignment = "Left"
Title.Font = Enum.Font.SourceSansBold
Title.TextSize = 18

local CloseBtn = Instance.new("TextButton", TopBar)
CloseBtn.Size = UDim2.new(0, 35, 0, 35)
CloseBtn.Position = UDim2.new(1, -35, 0, 0)
CloseBtn.Text = "X"
CloseBtn.BackgroundColor3 = Color3.fromRGB(180, 40, 40)
CloseBtn.TextColor3 = Color3.new(1, 1, 1)
CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

local Scroll = Instance.new("ScrollingFrame", Main)
Scroll.Size = UDim2.new(1, -20, 1, -95)
Scroll.Position = UDim2.new(0, 10, 0, 45)
Scroll.BackgroundTransparency = 1
Scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
Scroll.ScrollBarThickness = 2
Scroll.AutomaticCanvasSize = Enum.AutomaticSize.Y

local Layout = Instance.new("UIListLayout", Scroll)
Layout.Padding = UDim.new(0, 10)

local Input = Instance.new("TextBox", Main)
Input.Size = UDim2.new(1, -20, 0, 35)
Input.Position = UDim2.new(0, 10, 1, -40)
Input.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
Input.PlaceholderText = "Type here... (Channel-A)"
Input.Text = ""
Input.TextColor3 = Color3.new(1, 1, 1)
Input.Font = Enum.Font.SourceSans
Input.TextSize = 16

-- [[ CHAT LOGIC ]]

local function addMessage(user, msg, source)
    local Frame = Instance.new("Frame", Scroll)
    Frame.Size = UDim2.new(1, 0, 0, 55)
    Frame.BackgroundTransparency = 1
    
    local Img = Instance.new("ImageLabel", Frame)
    Img.Size = UDim2.new(0, 48, 0, 48)
    Img.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
    Img.BorderSizePixel = 0

    -- HEADER LOGIC
    local targetId = nil
    -- Clean the name to check against our ID map
    local cleanName = user:gsub(" %b()", ""):gsub(" %b[]", "")
    
    if UserIDMap[cleanName] then
        targetId = UserIDMap[cleanName]
    elseif source == "Game" then
        -- Try to find ID if not in our map
        local success, id = pcall(function() return Players:GetUserIdFromNameAsync(cleanName) end)
        if success then targetId = id end
    end

    if targetId then
        Img.Image = "rbxthumb://type=AvatarHeadShot&id="..targetId.."&w=150&h=150"
    else
        Img.Image = "rbxassetid://15563533221" -- Default Discord Icon
    end

    local Content = Instance.new("TextLabel", Frame)
    Content.Position = UDim2.new(0, 58, 0, 0)
    Content.Size = UDim2.new(1, -65, 1, 0)
    Content.RichText = true
    
    local nameColor = (source == "Game") and "#00FF96" or "#5865F2"
    Content.Text = "<b><font color='"..nameColor.."'>[" .. user .. "]</font></b>\n" .. msg
    Content.TextColor3 = Color3.new(1, 1, 1)
    Content.TextXAlignment = "Left"
    Content.TextYAlignment = "Top"
    Content.TextWrapped = true
    Content.BackgroundTransparency = 1
    Content.Font = Enum.Font.SourceSans
    Content.TextSize = 17
    
    Scroll.CanvasPosition = Vector2.new(0, Scroll.AbsoluteCanvasSize.Y + 100)
end

-- Sending Logic
Input.FocusLost:Connect(function(enter)
    if enter and Input.Text ~= "" then
        local msg = Input.Text
        Input.Text = ""
        
        local req = (syn and syn.request) or http_request or request
        if req then
            req({
                Url = webhookURL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = HttpService:JSONEncode({
                    ["content"] = msg,
                    ["username"] = lp.DisplayName .. " [" .. myExec .. "]"
                })
            })
        end
    end
end)

-- Polling Logic
task.spawn(function()
    while true do
        local success, response = pcall(function() return game:HttpGet(firebaseURL) end)
        if success and response ~= "null" then
            local data = HttpService:JSONDecode(response)
            if data.content ~= lastMsg then
                lastMsg = data.content
                addMessage(data.user or "Unknown", data.content, data.source)
            end
        end
        task.wait(1)
    end
end)
